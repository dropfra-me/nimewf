# Repository Guidelines

## Project Structure & Module Organization
- Source: `src/` with the public API in `src/nimewf.nim`. Place C-FFI shims in `src/nimewf/` (e.g., `ffi.nim`, `writer.nim`).
- Tests: `tests/` using Nim’s `unittest` (files starting with `t` are preferred, e.g., `tests/t_writer.nim`).
- Package: `nimewf.nimble` defines metadata and dependencies. Keep `srcDir = "src"`.

## Build, Test, and Development Commands
- Build library: `nimble build` — compiles the package (no binary is produced for libraries).
- Run tests: `nimble test` — executes `tests/*.nim` via `unittest`.
  - Note: On macOS with sandboxed shells, use the Lima VM wrapper: `./nimble.sh test`.
    This runs Nimble inside the configured VM with `libewf` available. If the local
    environment allows direct execution, both `nimble test` and `./nimble.sh test` work.
- Docs preview: `nim doc src/nimewf.nim` — generates API docs locally.
- Linking: always links against libewf using pkg-config via `config.nims` generated by Nimble tasks.
- Example compile flags (explicit, optional): `nim c --passC:$(pkg-config --cflags libewf) --passL:$(pkg-config --libs libewf) yourapp.nim`.

## Coding Style & Naming Conventions
- Nim style: 2-space indent; procs/vars lowerCamelCase; types PascalCase; modules snake_case.
- FFI layer (`nimewf/ffi`): 1:1 names with libewf, e.g., `proc libewf_handle_initialize* ... {.importc, cdecl.}`.
- Public API (`nimewf.nim` and helpers): ergonomic names without the `libewf_` prefix (e.g., `newWriter`, `writeChunk`). Re-export from `nimewf.nim`.

## Testing Guidelines
- Framework: `unittest`; add focused unit tests per high-level wrapper (writer/options/errors).
- Naming: test files start with `t_` or `t` and describe behavior (`t_writer_finalize.nim`).
- Coverage: prioritize I/O error paths, finalize semantics, and option mapping (compression, segments, format).

## Commit & Pull Request Guidelines
- Commits: concise, imperative (“Add writer finalize path”); prefer Conventional Commits (`feat:`, `fix:`, `test:`).
- PRs: include purpose, minimal repro or small code snippet, and platform/ABI assumptions (Windows/Linux, x64). Link issues and include before/after notes.

## Security & Configuration Tips
- Ensure `libewf` is available at link time. On Windows, set `LIBEWF_DIR` or pass flags in `config.nims`:
  ```nim
  when defined(windows):
    switch("passC", "-I%LIBEWF_DIR%/include")
    switch("passL", "-L%LIBEWF_DIR%/lib -lewf")
  ```
- Keep FFI pointers checked for `nil`; always free handles.

## Engineering Principles
- Keep code clean and focused: do exactly what’s needed, no more.
- Avoid unnecessary complexity: simple modules, minimal indirection.
- Favor modern, repeatable builds: Nimble tasks + pkg-config, vendor builds when helpful.
- Write well-tested code: add unit tests alongside wrappers; prioritize lifecycle and error paths.
